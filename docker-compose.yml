services:
  # MySQL ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤
  db:
    image: mysql:8.0 # MySQL 8.0 ì´ë¯¸ì§€ ì‚¬ìš©
    container_name: danawa-db
    environment:
      MYSQL_ROOT_PASSWORD: 1234 # application.propertiesì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
      MYSQL_DATABASE: danawa # application.propertiesì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
      TZ: Asia/Seoul # ì‹œê°„ëŒ€ ì„¤ì •
    ports:
      - "3307:3306" # í˜¸ìŠ¤íŠ¸ì™€ ì»¨í…Œì´ë„ˆ í¬íŠ¸ ì—°ê²°
    volumes:
      - db_data:/var/lib/mysql # ë°ì´í„° ìœ ì§€ë¥¼ ìœ„í•œ ë³¼ë¥¨ ë§ˆìš´íŠ¸
    networks:
      - danawa-net
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p1234"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Java Spring Boot ë°±ì—”ë“œ ì„œë¹„ìŠ¤
  backend:
    build:
      context: ./webservice # Dockerfileì´ ìˆëŠ” ê²½ë¡œ
      dockerfile: Dockerfile
    container_name: danawa-backend
    depends_on:
      db:
        condition: service_healthy # DBê°€ ì™„ì „íˆ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
    env_file: # ğŸ‘ˆ ì´ ë¶€ë¶„ì„ ì¶”ê°€
    - ./.env  # ğŸ‘ˆ .env íŒŒì¼ì„ ì½ì–´ GOOGLE_API_KEYë¥¼ ì£¼ì…
    ports:
      - "8080:8080"
    networks:
      - danawa-net
    environment:
      # application.propertiesì˜ DB ì„¤ì •ì„ Docker í™˜ê²½ì— ë§ê²Œ ì˜¤ë²„ë¼ì´ë“œ
      SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/danawa?useSSL=false&serverTimezone=Asia/Seoul&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 1234
      # Hibernate DDL ì„¤ì •: validateë¡œ ë³€ê²½í•˜ì—¬ í…Œì´ë¸” ìˆ˜ì • ë°©ì§€
      SPRING_JPA_HIBERNATE_DDL_AUTO: validate
      SPRING_JPA_DATABASE_PLATFORM: org.hibernate.dialect.MySQLDialect
      # TZ: Asia/Seoul # í•„ìš”ì‹œ ì‹œê°„ëŒ€ ì„¤ì •
    # JAR íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (Dockerfileì—ì„œ ë¹Œë“œëœ JAR ì‚¬ìš©)

  # React í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤
  frontend:
    build:
      context: ./webservice/frontend # Dockerfileì´ ìˆëŠ” ê²½ë¡œ
      dockerfile: Dockerfile
    container_name: danawa-frontend
    ports:
      - "3000:3000"
    networks:
      - danawa-net
    environment:
      - NODE_ENV=development # ê°œë°œ ëª¨ë“œ ì„¤ì •
      - CHOKIDAR_USEPOLLING=true # íŒŒì¼ ë³€ê²½ ê°ì§€ ë°©ì‹ ë³€ê²½ (Docker í™˜ê²½)
      - REACT_APP_API_URL=http://localhost:8080 # ë°±ì—”ë“œ API URL ì„¤ì • (ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ í˜¸ìŠ¤íŠ¸ í¬íŠ¸ ì‚¬ìš©)
    volumes:
      - ./webservice/frontend/src:/app/src # ì†ŒìŠ¤ ì½”ë“œ ì‹¤ì‹œê°„ ë™ê¸°í™”
      - ./webservice/frontend/public:/app/public # public í´ë” ì‹¤ì‹œê°„ ë™ê¸°í™”
    # Dockerfileì˜ CMD ["npm", "start"]ë¥¼ ì‚¬ìš©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰

  # Python í¬ë¡¤ëŸ¬ ì„œë¹„ìŠ¤ (ìˆ˜ë™ ì‹¤í–‰ ì „ìš©)
  # ì‚¬ìš©ë²•: docker-compose run -it crawler python crawler.py
  # ë˜ëŠ”: docker-compose run crawler python crawler.py --reviews
  crawler:
    build:
      context: .
      dockerfile: Dockerfile.crawler
    env_file:
      - ./.env
    depends_on:
      db:
        condition: service_healthy
    networks:
      - danawa-net
    volumes:
      - .:/app # í¬ë¡¤ëŸ¬ ìŠ¤í¬ë¦½íŠ¸ ë§ˆìš´íŠ¸
    working_dir: /app
    environment:
      DB_HOST: db
      DB_PORT: 3306
      DB_USER: root
      DB_PASSWORD: 1234
      DB_NAME: danawa
    # entrypoint ì œê±°: ìë™ ì‹¤í–‰ ë°©ì§€, ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥
    stdin_open: true # í‘œì¤€ ì…ë ¥ í™œì„±í™” (ëŒ€í™”í˜• ì…ë ¥ìš©)
    tty: true # TTY í• ë‹¹ (ëŒ€í™”í˜• í„°ë¯¸ë„ìš©)
    profiles:
      - manual # ìˆ˜ë™ ì‹¤í–‰ ì „ìš© í”„ë¡œí•„

  # ìš”ì•½ ì„œë¹„ìŠ¤ (ìˆ˜ë™ ì‹¤í–‰ ì „ìš©)
  # ì‚¬ìš©ë²•: docker-compose run summarizer python summarize_reviews.py
  summarizer:
    build:
      context: .
      dockerfile: Dockerfile.summarizer
    env_file:
      - ./.env
    depends_on:
      db:
        condition: service_healthy
    networks:
      - danawa-net
    environment:
      DB_HOST: db
      DB_PORT: 3306
      DB_USER: root
      DB_PASSWORD: 1234
      DB_NAME: danawa
    # entrypoint ì œê±°: ìë™ ì‹¤í–‰ ë°©ì§€, ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥
    # container_name ì œê±°: ìˆ˜ë™ ì‹¤í–‰ ì‹œ ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ ì‹¤í–‰ ê°€ëŠ¥
    profiles:
      - manual # ìˆ˜ë™ ì‹¤í–‰ ì „ìš© í”„ë¡œí•„

networks:
  danawa-net:
    driver: bridge

volumes:
  db_data: # DB ë°ì´í„° ì €ì¥ ë³¼ë¥¨
  maven_repo: # Maven ì˜ì¡´ì„± ì €ì¥ ë³¼ë¥¨