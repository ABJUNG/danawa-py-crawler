services:
  # MySQL ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤
  db:
    image: mysql:8.0 # MySQL 8.0 ì´ë¯¸ì§€ ì‚¬ìš©
    container_name: danawa-db
    environment:
      MYSQL_ROOT_PASSWORD: 1234 # application.propertiesì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
      MYSQL_DATABASE: danawa # application.propertiesì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
      TZ: Asia/Seoul # ì‹œê°„ëŒ€ ì„¤ì •
    ports:
      - "3307:3306" # í˜¸ìŠ¤íŠ¸ì™€ ì»¨í…Œì´ë„ˆ í¬íŠ¸ ì—°ê²°
    volumes:
      - db_data:/var/lib/mysql # ë°ì´í„° ìœ ì§€ë¥¼ ìœ„í•œ ë³¼ë¥¨ ë§ˆìš´íŠ¸
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --default-authentication-plugin=mysql_native_password

  # Java Spring Boot ë°±ì—”ë“œ ì„œë¹„ìŠ¤
  backend:
    build:
      context: ./webservice # Dockerfileì´ ìˆëŠ” ê²½ë¡œ
      dockerfile: Dockerfile
    container_name: danawa-backend
    depends_on:
      - db # DB ì„œë¹„ìŠ¤ê°€ ë¨¼ì € ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •
    env_file: # ğŸ‘ˆ ì´ ë¶€ë¶„ì„ ì¶”ê°€
    - ./.env  # ğŸ‘ˆ .env íŒŒì¼ì„ ì½ì–´ GOOGLE_API_KEYë¥¼ ì£¼ì…
    ports:
      - "8080:8080"
    environment:
      # application.propertiesì˜ DB ì„¤ì •ì„ Docker í™˜ê²½ì— ë§ê²Œ ì˜¤ë²„ë¼ì´ë“œ
      SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/danawa?useSSL=false&serverTimezone=Asia/Seoul&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 1234
      # TZ: Asia/Seoul # í•„ìš”ì‹œ ì‹œê°„ëŒ€ ì„¤ì •
    # JAR íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (Dockerfileì—ì„œ ë¹Œë“œëœ JAR ì‚¬ìš©)

  # React í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤
  frontend:
    build:
      context: ./webservice/frontend # Dockerfileì´ ìˆëŠ” ê²½ë¡œ
      dockerfile: Dockerfile
    container_name: danawa-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development # ê°œë°œ ëª¨ë“œ ì„¤ì •
      - CHOKIDAR_USEPOLLING=true # íŒŒì¼ ë³€ê²½ ê°ì§€ ë°©ì‹ ë³€ê²½ (Docker í™˜ê²½)
      - REACT_APP_API_URL=http://localhost:8080 # ë°±ì—”ë“œ API URL ì„¤ì • (ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ í˜¸ìŠ¤íŠ¸ í¬íŠ¸ ì‚¬ìš©)
    # Dockerfileì˜ CMD ["npm", "start"]ë¥¼ ì‚¬ìš©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰

  # Python í¬ë¡¤ëŸ¬ ì„œë¹„ìŠ¤ (í•„ìš” ì‹œ ì‹¤í–‰)
  crawler:
    build:
      context: .
      dockerfile: Dockerfile.crawler
    env_file: # ğŸ‘ˆ ì´ ë¶€ë¶„ì„ ì¶”ê°€
      - ./.env  # ğŸ‘ˆ .env íŒŒì¼ì˜ ëª¨ë“  ë³€ìˆ˜ë¥¼ ì´ ì»¨í…Œì´ë„ˆë¡œ ì£¼ì…
    depends_on:
      - db
    volumes:
      - .:/app # í¬ë¡¤ëŸ¬ ìŠ¤í¬ë¦½íŠ¸ ë§ˆìš´íŠ¸
    working_dir: /app
    environment:
      DB_HOST: db # docker-compose ë„¤íŠ¸ì›Œí¬ ë‚´ì˜ DB ì„œë¹„ìŠ¤ ì´ë¦„ ì‚¬ìš©
      DB_PORT: 3306
      DB_USER: root
      DB_PASSWORD: 1234
      DB_NAME: danawa
      # TZ: Asia/Seoul # í•„ìš”ì‹œ ì‹œê°„ëŒ€ ì„¤ì •
    # docker-compose up ì‹œ ë°”ë¡œ ì‹¤í–‰ë˜ì§€ ì•Šê³ , í•„ìš”í•  ë•Œ ìˆ˜ë™ ì‹¤í–‰í•˜ë„ë¡ entrypoint ì„¤ì •
    entrypoint: ["python", "crawler.py"]
    # tty: true # í•„ìš” ì‹œ ì»¨í…Œì´ë„ˆ ìœ ì§€

  summarizer:
      build:
        context: .
        dockerfile: Dockerfile.summarizer # 1. ì´ì „ ë‹¨ê³„ì—ì„œ ìƒì„±í•œ Dockerfile.summarizer ì‚¬ìš©
      container_name: danawa-summarizer
      env_file: # .env íŒŒì¼ì—ì„œ GOOGLE_API_KEYë¥¼ ì½ì–´ì˜´
        - ./.env
      depends_on:
        - db
      networks: # 'db' ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ ë™ì¼ ë„¤íŠ¸ì›Œí¬ ì‚¬ìš©
        - danawa-net
      # summarize_reviews.pyì— DB_HOST='db' ë“±ì´ í•˜ë“œì½”ë”©ë˜ì–´ ìˆìœ¼ë¯€ë¡œ
      # ë³„ë„ DB í™˜ê²½ ë³€ìˆ˜ëŠ” í•„ìš” ì—†ìŒ. GOOGLE_API_KEYë§Œ .envë¡œ ì£¼ì….
      entrypoint: ["python", "summarize_reviews.py"] # 2. ìˆ˜ë™ ì‹¤í–‰ìš© entrypoint
volumes:
  db_data: # DB ë°ì´í„° ì €ì¥ ë³¼ë¥¨
  maven_repo: # Maven ì˜ì¡´ì„± ì €ì¥ ë³¼ë¥¨